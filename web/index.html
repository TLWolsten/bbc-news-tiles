<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BBC News — 8 Tiles (Netlify)</title>
  <style>
    :root { --bg:#0b0c10; --card:#12151a; --text:#e6e6e6; --muted:#a6a6a6; --accent:#bbdefb; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; background: var(--bg); color: var(--text); }
    header { padding: 20px; text-align: center; }
    h1 { margin:0; font-weight: 800; letter-spacing: .2px; }
    .grid { display:grid; gap:16px; padding: 16px; grid-template-columns: repeat(1, minmax(0,1fr)); }
    @media (min-width:640px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (min-width:1024px){ .grid{ grid-template-columns: repeat(4, 1fr); } }
    .tile { background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px 14px 10px; box-shadow: 0 10px 30px rgba(0,0,0,.25); min-height: 300px; display:flex; flex-direction:column; }
    .tile h2 { margin:4px 2px 10px; font-size: 16px; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing:.6px; display:flex; align-items:center; gap:8px; }
    .count { color: var(--muted); font-size:12px; font-weight:600; }
    .list { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px; }
    .item a { color: var(--text); text-decoration:none; }
    .item a:hover { text-decoration: underline; }
    .meta { color: var(--muted); font-size: 12px; margin-top: 2px; }
    .loading, .error { color: var(--muted); font-size: 14px; padding: 10px; }
    footer { text-align:center; color: var(--muted); font-size: 12px; padding: 10px 0 20px; }
    .toolbar { text-align:center; margin-bottom:10px; }
    .toolbar a { color: var(--accent); }
  </style>
</head>
<body>
  <header>
    <h1>BBC News — 8 Tiles</h1>
    <div class="meta">Netlify build. Uses serverless function at <code>/.netlify/functions/rss</code>.</div>
    <div class="toolbar">
      <a href="/.netlify/functions/rss?feed=top" target="_blank">Test API (Top JSON)</a>
    </div>
  </header>

  <main class="grid" id="grid"></main>

  <footer>Built for you • <span id="updated"></span></footer>

<script>
// Always use the Netlify Functions relative base
const API_BASE = '/.netlify/functions';

const FEEDS = [
  { key:"top",          title:"Top Stories" },
  { key:"world",        title:"World" },
  { key:"uk",           title:"UK" },
  { key:"business",     title:"Business" },
  { key:"technology",   title:"Technology" },
  { key:"entertainment",title:"Entertainment" },
  { key:"science",      title:"Science & Environment" },
  { key:"health",       title:"Health" }
];

const grid = document.getElementById('grid');

function createTile({key, title}){
  const el = document.createElement('section');
  el.className = 'tile';
  el.innerHTML = `
    <h2>${title} <span class="count" id="count-${key}"></span></h2>
    <div class="loading" id="loading-${key}">Loading…</div>
    <ul class="list" id="list-${key}" hidden></ul>
    <div class="error" id="error-${key}" hidden></div>
  `;
  return el;
}

async function fetchFeed(key){
  const res = await fetch(`${API_BASE}/rss?feed=${encodeURIComponent(key)}`);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

function formatDate(iso){
  try { return new Date(iso).toLocaleString(); } catch { return ''; }
}

async function load(){
  const tasks = FEEDS.map(async (f)=>{
    const tile = createTile(f);
    grid.appendChild(tile);
    try {
      const data = await fetchFeed(f.key);
      const list = document.getElementById(`list-${f.key}`);
      const count = document.getElementById(`count-${f.key}`);
      const loading = document.getElementById(`loading-${f.key}`);
      loading.hidden = true;
      count.textContent = `(${data.items.length})`;
      list.hidden = false;
      list.innerHTML = data.items.slice(0, 10).map(item => `
        <li class="item">
          <a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.title}</a>
          <div class="meta">${formatDate(item.pubDate)}</div>
        </li>
      `).join('');
    } catch (e) {
      const loading = document.getElementById(`loading-${f.key}`);
      const err = document.getElementById(`error-${f.key}`);
      loading.hidden = true; err.hidden = false; err.textContent = (e && e.message) ? e.message : 'Failed to load.';
      console.error('Feed error', f.key, e);
    }
  });
  await Promise.all(tasks);
  document.getElementById('updated').textContent = `Updated ${new Date().toLocaleString()}`;
}

load();
</script>
</body>
</html>
